#include <jni.h>
#include <Python.h>

// Note code in this file is formatted according to the header generated by javah. This makes it easier
// to follow up changes in the header.

/*
 * Class:     org_jpy_python_PyLib
 * Method:    isInitialized
 * Signature: ()Z
 */
JNIEXPORT jboolean JNICALL Java_org_jpy_python_PyLib_isInitialized
  (JNIEnv* jenv, jclass pyLib)
{
    int retCode;
    retCode = Py_IsInitialized();
    printf("Java_org_jpy_python_PyLib_isInitialized: retCode=%d\n", retCode);
    return retCode != 0;
}

/*
 * Class:     org_jpy_python_PyLib
 * Method:    initialize
 * Signature: ([Ljava/lang/String;Z)Z
 */
JNIEXPORT jboolean JNICALL Java_org_jpy_python_PyLib_initialize
  (JNIEnv* jenv, jclass pyLib, jobjectArray options, jboolean debug)
{
    printf("Java_org_jpy_python_PyLib_initialize called\n");
    if (!Py_IsInitialized()) {
        //Py_SetProgramName("java");
        Py_Initialize();
    }
    return JNI_TRUE;
}
  

/*
 * Class:     org_jpy_python_PyLib
 * Method:    destroy
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_org_jpy_python_PyLib_destroy
  (JNIEnv* jenv, jclass pyLib)
{
    printf("Java_org_jpy_python_PyLib_destroy called\n");
    if (Py_IsInitialized()) {
        Py_Finalize();
    }
}

/*
 * Class:     org_jpy_python_PyLib
 * Method:    decref
 * Signature: (J)V
 */
JNIEXPORT void JNICALL Java_org_jpy_python_PyLib_decref
  (JNIEnv* jenv, jclass pyLib, jlong objId)
{
    printf("Java_org_jpy_python_PyLib_decref: objId=%p\n", (PyObject*) objId);
    Py_DECREF((PyObject*) objId);
}


/*
 * Class:     org_jpy_python_PyLib
 * Method:    getModule
 * Signature: (Ljava/lang/String;)J
 */
JNIEXPORT jlong JNICALL Java_org_jpy_python_PyLib_importModule
  (JNIEnv* jenv, jclass pyLib, jstring name)
{
    PyObject* pName;
    PyObject* pModule;
    const char* nameChars;

    nameChars = (*jenv)->GetStringUTFChars(jenv, name, NULL);
    printf("Java_org_jpy_python_PyLib_getModule: name='%s'\n", nameChars);
    pName = PyUnicode_FromString(nameChars);
    pModule = PyImport_Import(pName);
    /* pModule is a new reference */
    Py_DECREF(pName);
    (*jenv)->ReleaseStringUTFChars(jenv, name, nameChars);
    return (jlong) pModule;
}


/*
 * Class:     org_jpy_python_PyLib
 * Method:    getAttributeValue
 * Signature: (JLjava/lang/String;)J
 */
JNIEXPORT jlong JNICALL Java_org_jpy_python_PyLib_getAttributeValue
  (JNIEnv* jenv, jclass pyLib, jlong objId, jstring name)
{
    PyObject* pValue;
    const char* nameChars;

    nameChars = (*jenv)->GetStringUTFChars(jenv, name, NULL);
    printf("Java_org_jpy_python_PyLib_getAttributeValue: objId=%p, name='%s'\n", (PyObject*) objId, nameChars);
    pValue = PyObject_GetAttrString((PyObject*) objId, nameChars);
    /* pValue is a new reference */
    (*jenv)->ReleaseStringUTFChars(jenv, name, nameChars);
    return (jlong) pValue;
}


/*
 * Class:     org_jpy_python_PyLib
 * Method:    setAttributeValue
 * Signature: (JLjava/lang/String;J)V
 */
JNIEXPORT void JNICALL Java_org_jpy_python_PyLib_setAttributeValue
  (JNIEnv* jenv, jclass pyLib, jlong objId, jstring name, jlong value)
{
    int retCode;
    const char* nameChars;

    nameChars = (*jenv)->GetStringUTFChars(jenv, name, NULL);
    printf("Java_org_jpy_python_PyLib_setAttributeValue: objId=%p, name='%s', value=%p\n", (PyObject*)objId, nameChars, (PyObject*)value);
    retCode = PyObject_SetAttrString((PyObject*) objId, nameChars, (PyObject*) value);
    (*jenv)->ReleaseStringUTFChars(jenv, name, nameChars);
    if (retCode < 0) {
        // todo: throw
    }
}


/*
 * Class:     org_jpy_python_PyLib
 * Method:    execScript
 * Signature: (Ljava/lang/String;)J
 */
JNIEXPORT void JNICALL Java_org_jpy_python_PyLib_execScript
  (JNIEnv* jenv, jclass pyLib, jstring script)
{
    const char* scriptChars;
    int retCode;

    scriptChars = (*jenv)->GetStringUTFChars(jenv, script, NULL);
    printf("Java_org_jpy_python_PyLib_execScript: script='%s'\n", scriptChars);
    retCode = PyRun_SimpleString(scriptChars);
    (*jenv)->ReleaseStringUTFChars(jenv, script, scriptChars);
    if (retCode < 0) {
        // todo: throw
    }
}


/*
 * Class:     org_jpy_python_PyLib
 * Method:    call
 * Signature: (JZLjava/lang/String;[Ljava/lang/Object;)Ljava/lang/Object;
 */
JNIEXPORT jobject JNICALL Java_org_jpy_python_PyLib_call
  (JNIEnv* jenv, jclass pyLib, jlong objId, jboolean isMethod, jstring name, jobjectArray args)
{
    const char* nameChars;
    nameChars = (*jenv)->GetStringUTFChars(jenv, name, NULL);
    printf("Java_org_jpy_python_PyLib_callWithTypeInfo: objId=%p, name='%s'\n", (PyObject*)objId, nameChars);
    // todo: implement Java_org_jpy_python_PyLib_call

/*
    PyObject *pName, *pModule, *pDict, *pFunc;
    PyObject *pArgs, *pValue;
    int argCount;
    int i;


    argCount = ...;

    pFunc = PyObject_GetAttrString(pModule, nameChars);
    // pFunc is a new reference

    if (pFunc && PyCallable_Check(pFunc)) {
        pArgs = PyTuple_New(argCount);
        for (i = 0; i < argCount; i++) {

            pValue = PyLong_FromLong(atoi(argv[i + 3]));
            if (!pValue) {
                Py_DECREF(pArgs);
                Py_DECREF(pModule);
                fprintf(stderr, "Cannot convert argument\n");
                return 1;
            }
            // pValue reference stolen here
            PyTuple_SetItem(pArgs, i, pValue);
        }
        pValue = PyObject_CallObject(pFunc, pArgs);
        Py_DECREF(pArgs);
        if (pValue != NULL) {
            printf("Result of call: %ld\n", PyLong_AsLong(pValue));
            Py_DECREF(pValue);
        }
        else {
            Py_DECREF(pFunc);
            PyErr_Print();
            fprintf(stderr,"Call failed\n");
            return 1;
        }
    }
    else {
        if (PyErr_Occurred())
            PyErr_Print();
        fprintf(stderr, "Cannot find function \"%s\"\n", argv[2]);
    }
    Py_XDECREF(pFunc);
    Py_DECREF(pModule);

error:
    (*jenv)->ReleaseStringUTFChars(jenv, name, nameChars);
*/
    return NULL;
}


/*
 * Class:     org_jpy_python_PyLib
 * Method:    call
 * Signature: (JZLjava/lang/String;[Ljava/lang/Class;Ljava/lang/Class;[Ljava/lang/Object;)Ljava/lang/Object;
 */
JNIEXPORT jobject JNICALL Java_org_jpy_python_PyLib_callWithTypeInfo
  (JNIEnv* jenv, jclass pyLib, jlong objId, jboolean isMethod, jstring name, jobjectArray paramTypes, jclass returnType, jobjectArray args)
{
    const char* nameChars;

    nameChars = (*jenv)->GetStringUTFChars(jenv, name, NULL);
    printf("Java_org_jpy_python_PyLib_callWithTypeInfo: objId=%p, name='%s'\n", (PyObject*)objId, nameChars);
    (*jenv)->ReleaseStringUTFChars(jenv, name, nameChars);
    // todo: implement Java_org_jpy_python_PyLib_callWithTypeInfo
    return NULL;
}

